<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Drink Machine</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #333;
      color: white;
      padding: 15px;
    }
    header img {
      height: 40px;
      margin-right: 15px;
    }
    header h1 {
      font-size: 28px;
      margin: 0;
    }
    nav {
      display: flex;
      background: #444;
      color: white;
      padding: 10px;
      justify-content: center;
      gap: 40px;
    }
    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    nav button:hover { text-decoration: underline; }
    .tab { display: none; padding: 20px; }
    .active { display: block; }
    .drink-card {
      background: white;
      padding: 20px;
      margin: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      font-size: 20px;
      cursor: pointer;
    }
    .drink-card.unavailable { opacity: 0.4; cursor: not-allowed; }
    .pumps {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .pump-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .pump-card:hover { background: #e6f0ff; }
    .modal { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; text-align: center; }
    .ingredients { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .ingredient-btn { font-size: 22px; padding: 20px; min-width: 180px; border: none; border-radius: 10px; background: #3498db; color: white; cursor: pointer; }
    .ingredient-btn:hover { background: #2980b9; }
  </style>
</head>
<body>
  <!-- Header con logo -->
  <header>
    <img src="cocktail.svg" alt="Cocktail">
    <h1>Drink Machine</h1>
  </header>

  <!-- NavegaciÃ³n -->
  <nav>
    <button onclick="showTab('drinks')">Drinks</button>
    <button onclick="showTab('pumps')">Configurar Bombas</button>
  </nav>

  <!-- Pantalla de Drinks -->
  <div id="drinks" class="tab active">
    <h2>Lista de Drinks</h2>
    <div id="drinks-list"></div>
  </div>

  <!-- Pantalla de Bombas -->
  <div id="pumps" class="tab">
    <h2>Bombas</h2>
    <div class="pumps">
      <div class="pump-card" onclick="openModal(1)">Pump 1<br><span id="pump-1-ingredient">...</span></div>
      <div class="pump-card" onclick="openModal(2)">Pump 2<br><span id="pump-2-ingredient">...</span></div>
      <div class="pump-card" onclick="openModal(3)">Pump 3<br><span id="pump-3-ingredient">...</span></div>
      <div class="pump-card" onclick="openModal(4)">Pump 4<br><span id="pump-4-ingredient">...</span></div>
    </div>
  </div>

  <!-- Modal ingredientes -->
  <div id="ingredient-modal" class="modal">
    <div class="modal-content">
      <h2>Seleccionar Ingrediente</h2>
      <div id="ingredients-list" class="ingredients"></div>
      <button onclick="closeModal()">Cerrar</button>
    </div>
  </div>

  <script>
    const API_BASE = `http://${window.location.hostname}:8000`;  // ðŸ”¹ dinÃ¡mico segÃºn dÃ³nde abras el FE
    let ingredients = [];
    let selectedPump = null;

    function showTab(id) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'drinks') loadDrinks();
      if (id === 'pumps') loadPumps();
    }

    // ðŸš€ DRINKS
    async function loadDrinks() {
      const resp = await fetch(`${API_BASE}/drinks`);
      const drinks = await resp.json();
      const list = document.getElementById("drinks-list");
      list.innerHTML = "";

      // disponibles primero
      drinks.sort((a, b) => (b.is_available === true) - (a.is_available === true));

      drinks.forEach(drink => {
        const card = document.createElement("div");
        card.className = "drink-card" + (drink.is_available ? "" : " unavailable");
        card.innerText = drink.name;
        if (drink.is_available) {
          card.onclick = () => prepareDrink(drink.id);
        }
        list.appendChild(card);
      });
    }

    async function prepareDrink(id) {
      const resp = await fetch(`${API_BASE}/drinks/${id}/prepare`, { method: "POST" });
      const data = await resp.json();
      alert(data.message);
    }

    // ðŸš€ PUMPS
    async function loadPumps() {
      // ingredientes
      const ingResp = await fetch(`${API_BASE}/ingredients`);
      ingredients = await ingResp.json();

      // bombas
      const pumpResp = await fetch(`${API_BASE}/pumps`);
      const pumps = await pumpResp.json();

      pumps.forEach(pump => {
        document.getElementById(`pump-${pump.id}-ingredient`).innerText = pump.ingredient ? pump.ingredient.name : "[No asignado]";
      });
    }

    function openModal(pumpId) {
      selectedPump = pumpId;
      const list = document.getElementById("ingredients-list");
      list.innerHTML = "";
      ingredients.forEach(ing => {
        const btn = document.createElement("button");
        btn.className = "ingredient-btn";
        btn.innerText = ing.name;
        btn.onclick = () => assignIngredient(pumpId, ing);
        list.appendChild(btn);
      });
      document.getElementById("ingredient-modal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("ingredient-modal").style.display = "none";
      selectedPump = null;
    }

    async function assignIngredient(pumpId, ingredient) {
      await fetch(`${API_BASE}/pumps/${pumpId}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ ingredient_id: ingredient.id })
      });

      // ðŸ”¹ refrescar toda la grilla de bombas
      await loadPumps();

      closeModal();
    }

    // inicial
    loadDrinks();
  </script>
</body>
</html>
